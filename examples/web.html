<!DOCTYPE html>
<html lang="en_GB">

    <head>
        <title>WebUSB demo</title>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
        <!-- Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
        <!-- DAP.js -->
        <script type="text/javascript" src="../bundles/dap.bundle.js"></script>
        <style>
            body {
                font-family: 'Open Sans';            
            }
            
            pre {
                padding: 8px;
                margin: 0 0 15px;
                font-size: 13px;
                line-height: 1.72222;
                color: inherit;
                white-space: pre;
                background-color: #fff;
                border: 2px solid #e7e9ec;
                border-radius: 6px;
                min-height: 100px;
            }

            p {
                margin: 0 0 15px;
                font-size: 18px;
                line-height: 1.8em;
            }

            input {
                width: 100%;
            }
            
            .container {
                max-width: 900px;
                margin: 0 auto;
            
                padding-top: 20px;
            }
            
            .demo_head {
                margin-top: 20px;
                font-size: 30px;
            }
            
            .letter-ol {
                list-style-type: lower-alpha;
            }

            .btn-group {
                min-width: 100%;
            }

            .btn-flash {
                width: 100%;
            }

            #drop {
                position: relative;
                padding: 10px;
                min-width: 100%;
                outline: 2px dashed #e7e9ec;
                text-align: center;
            }

            #drop.hover {
                background-color: rgba(255, 255, 255, 0.15);
            }

            #icon {
                width: 100%;
                fill: #65abff;
            }

            #file {
                width: 0.1px;
                height: 0.1px;
                opacity: 0;
                z-index: -1;
                pointer-events: none;
            }

            #select {
                position: absolute;
                left: 0;
                right: 0;
                visibility: hidden;
            }

            #label {
                cursor: pointer;
                text-align: center;
                margin-bottom: 0px;
            }

            #label:hover strong {
                color: #8bb5ba;
            }

        </style>
    </head>

    <body>
        <div class='container'>
            <p style="display: none" id="noWebUSB" class="palette palette-alizarin">
            It looks like your browser does not support WebUSB, or does not have it enabled. For instructions about enabling it, <a href="https://developers.google.com/web/updates/2016/03/access-usb-devices-on-the-web#before_we_start" style="color: #000;">click here</a>.
            </p>

            <p class="demo_head">DAP.js Demo</p>

            <p>
            Flash and debug mbed enabled development boards in the browser
            using CMSIS-DAP over WebUSB. Currently tested in Google Chrome
            on Windows with an <a href="https://os.mbed.com/platforms/FRDM-K64F/">NXP Freedom K64F</a> and the <a href="http://tech.microbit.org/">micro:bit</a>.
            </p>

            <p>
            WebUSB is an experimental technology providing low-level USB
            access from JavaScript code running in the browser.
            </p>
            
            <div class="row">
                <div class="col-md-5">
                    <ol>
                        <li>
                            <p>
                                Select a device:
                            </p>
                            <p>
                                <button onclick="selectBoard()" class="btn btn-primary">Choose</button>
                            </p>
                        </li>
                        <li>
                            <p>
                                Choose platform:
                            </p>
                            <p>
                                <select id="platform-chooser" class="form-control" disabled>
                                    <optgroup id="platform-detected" label="Detected">
                                    </optgroup>
                                    <optgroup label="Others">
                                        <option value="generic">Generic Cortex-M (no flash support)</option>
                                        <option value="microbit">micro:bit</option>
                                        <option value="K64F">NXP Freedom K64F</option>
                                    </optgroup>
                                </select>
                            </p>
                            <p>
                                <button id='connect' onclick="connect()" class="btn btn-success" disabled>Connect</button>
                            </p>
                        </li>
                        <li>
                            <p>
                                Flash a binary:
                            </p>
                            <p>
                                <div class="btn-group">
                                    <button onclick="flash('green')" class="btn btn-flash btn-success when-connected" disabled>Flash Green</button>
                                    <button onclick="flash('red')" class="btn btn-flash btn-danger when-connected" disabled>Flash Red</button>
                                </div>
                            </p>
                            <p>
                                <div id="drop" class="when-connected" disabled>
                                    <svg id="icon" xmlns="http://www.w3.org/2000/svg" width="37" height="32" viewBox="0 0 50 43">
                                        <path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"/>
                                    </svg>
                                    <input id="file" type="file" class="when-connected" disabled />
                                    <label id="label" for="file" class="when-connected" disabled>
                                        <strong>Choose a binary</strong>
                                        <span>or drag it here</span>
                                    </label>
                                    <div id="status">
                                        <div id="bar"></div>
                                        <div id="transfer"></div>
                                    </div>
                                </div>
                            </p>
                            <div id='progress-container' style='display: none'>
                                <div class="progress">
                                    <div class="progress-bar" style="width: 0%" id="flash-progress"></div>
                                </div>
                            </div>
                        </li>

                        <li>
                            <p>
                                Tools:
                            </p>
                            <p>
                                <div class="btn-group">
                                    <button onclick="halt()" class="btn btn-danger when-connected" disabled>Halt</button>
                                    <button onclick="resume()" class="btn btn-primary when-connected" disabled>Resume</button>
                                </div>
                            </p>
                            <p>
                                <button onclick="step()" class="btn btn-info when-connected" disabled>Step</button>
                            </p>
                            <p>
                                <button onclick="printRegisters()" class="btn btn-info when-connected" disabled>Read Registers</button>
                            </p>
                        </li>
                        <li>
                            <p>
                                Serial monitor:
                            </p>
                            <p>
                                Baud Rate:
                                <select id="baudRate" class="when-connected" disabled>
                                    <option value="9600">9600</option>
                                    <option value="14400">14400</option>
                                    <option value="19200">19200</option>
                                    <option value="28800">28800</option>
                                    <option value="38400">38400</option>
                                    <option value="57600">57600</option>
                                    <option value="115200">115200</option>
                                </select>
                                <div class="btn-group">
                                    <button onclick="startSerialMonitor()" class="btn btn-success when-connected" disabled>Start</button>
                                    <button onclick="stopSerialMonitor()" class="btn btn-danger when-connected" disabled>Stop</button>
                                </div>
                            </p>
                        </li>
                    </ol>
                </div>

                <div class="col-md-7">
                    Output:
                    <pre id="logger"></pre>
                    Serial monitor:
                    <p>
                        <input id="serialMonitorInput" class="when-connected" type="text" maxlength="63" placeholder="Write to a board" onchange="writeSerial()">
                    </p>
                    <pre id="serialMonitor"></pre>
                </div>
            </div>
        </div>

        <script>
            function arrToString(arr) {
                let r = "";
                for (let i = 0; i < arr.length; ++i) {
                    r += ("0000" + i).slice(-4) + ": " + ("00000000" + (arr[i] >>> 0).toString(16)).slice(-8);

                    if (i !== arr.length - 1) {
                        r += "\n";
                    }
                }
                return r;
            }

            function machineStateToString(s) {
                return "REGS:\n" + arrToString(s.registers);
            }

            async function resume() {
                await this.target.resume();
                log("Resumed.");
            }

            async function printRegisters() {
                const halt = false;

                await this.target.halt();
                const st = await snapshotMachineState();

                clearLog();
                log(machineStateToString(st));
            }

            async function step() {
                await this.target.debug.step();
                const st = await snapshotMachineState();

                clearLog();
                log(machineStateToString(st));
            }

            function log(data) {
                logger = document.getElementById("logger");
                logger.innerHTML = logger.innerHTML + data + "\n";
            }

            function clearLog() {
                document.getElementById("logger").innerHTML = "";
            }

            function logSerial(data) {
                logger = document.getElementById("serialMonitor");
                logger.innerHTML = logger.innerHTML + data + "\n";
            }

            function clearLogSerial() {
                document.getElementById("serialMonitor").innerHTML = "";
            }

            /**
             * Snapshot the current state of the CPU. Reads all general-purpose registers, and returns them in an array.
             */
            async function snapshotMachineState() {
                const state = {
                    registers: [],
                };
                for (let i = 0; i < 16; i++) {
                    state.registers[i] = await this.target.readCoreRegister(i);
                }
                return state;
            }

            async function connect() {
                clearLog();
                clearLogSerial();
                this.hid = new DAPjs.HID(this.device);

                log("Opening device.");

                // open hid device
                await this.hid.open();

                log("Device opened.");

                this.dapDevice = new DAPjs.DAP(this.hid);

                const xhr = new XMLHttpRequest();
                xhr.responseType = "json";
                xhr.open("GET", "../flash_targets/flash_targets.json", true);
                xhr.onload = async (e) => {
                    if (xhr.status !== 200) return log(xhr.statusText);

                    let flashAlgorithm = new DAPjs.FlashAlgorithm(xhr.response, this.deviceCode);
                    if (!flashAlgorithm.flashAlgo) return log("No flashing algorithm can be found for this board.");

                    this.serial = new DAPjs.Serial(dapDevice);
                    this.target = new DAPjs.FlashTarget(this.dapDevice, flashAlgorithm);

                    log("Initialising device.");
                    await this.target.init();

                    log("Halting target.");
                    await this.target.halt();
                    log("Target halted.");

                    const [imp, isa, type] = await this.target.readCoreType();
                    log(`Connected to an ARM ${DAPjs.CoreNames.get(type)} (${DAPjs.ISANames.get(isa)})`);
                    document.getElementById("connect").disabled = true;

                    const elements = Array.from(document.querySelectorAll(".when-connected"));

                    for (const elem of elements) {
                        elem.disabled = false;
                    }
                };
                xhr.send();
            }

            async function halt() {
                await this.target.halt();
                log("Halted.");
            }

            async function flash(color){
                const binariesPath = "../binaries/";
                switch (this.deviceCode) {
                    case "0240":
                        binary = binariesPath + "k64f-blinky-" + color + ".bin";
                        break;
                    case "9900":
                        binary = binariesPath + "microbit-say-" + color + ".hex";
                        break;
                    case "1050":
                        binary = binariesPath + "lpc812-blinky-" + color + ".bin";
                        break;
                    case "1100":
                        binary = binariesPath + "nrf51dk-led-" + color + ".hex";
                        break;
                    default:
                        log("No binary found for this target");
                        return;
                }
                const xhr = new XMLHttpRequest();
                xhr.responseType = "arraybuffer";
                xhr.open("GET", binary, true);
                xhr.onload = async (e) => {
                    this.flashProgram(xhr.response)
                };
                xhr.send();
            }

            async function flashProgram(binary) {
                this.flashProgressBar.style.width = "0%";
                this.flashProgressBarContainer.style.display = "block";
                log(`Flashing program on board.`);
                const timeNow =  performance.now();
                const flashMSD =  new DAPjs.Flash(dapDevice);
                await flashMSD.flash(binary, (progress) => {
                    this.flashProgressBar.style.width = `${progress * 100}%`;
                });
                const timePassed =  performance.now() - timeNow;
                log(`Successfully flashed binary in ${timePassed.toFixed(2)} ms.` );
                log("Done.");
            }

            async function startSerialMonitor() {
                var elem = document.getElementById("baudRate");
                var baudRate = elem.options[elem.selectedIndex].value;
                await this.serial.initialize(baudRate);
                this.serial.start((data) => {
                    logSerial(data);
                });
            }

            function writeSerial() {
                var elem = document.getElementById("serialMonitorInput");
                this.serial.write(elem.value);
                elem.value = "";
            }

            function stopSerialMonitor() {
                this.serial.stop();
                clearLogSerial();
            }

            async function selectBoard() {
                this.device = await navigator.usb.requestDevice({ filters: [{vendorId: 0x0d28}]});
                this.deviceCode = this.device.serialNumber.slice(0, 4);
                const platform = await this.selector.lookupDevice(this.deviceCode);
                document.getElementById("connect").disabled = false;
                document.getElementById("platform-chooser").disabled = false;
                document.getElementById("platform-chooser").innerHTML = `<option value='${platform.productCode}' id='${platform.productCode}'>${platform.name}</option>`;
            }

            window.onload = function() {
                this.flashProgressBar = document.getElementById('flash-progress');
                this.flashProgressBarContainer = document.getElementById('progress-container');
                this.selector = new DAPjs.PlatformSelector();
                navigator.usb.addEventListener('disconnect', disconnectEvent => {
                    if (this.device && this.device.serialNumber == disconnectEvent.device.serialNumber) {
                        this.device = null;
                        const elements = Array.from(document.querySelectorAll(".when-connected"));
                        for (const elem of elements) {
                            elem.disabled = true;
                        }
                        clearLog();
                        log("Device disconnected");
                        clearLogSerial();
                    }
                });
                let dropEl = document.getElementById("drop");
                let fileEl = document.getElementById("file");

                fileEl.addEventListener("change", event => {
                    reader = new FileReader();
                    reader.onload = function(e) {
                        flashProgram(reader.result);
                    }
                    reader.readAsArrayBuffer(event.target.files[0]);
                });

                dropEl.addEventListener("drop", event => {
                    reader = new FileReader();
                    reader.onload = function(e) {
                        flashProgram(reader.result);
                    }
                    reader.readAsArrayBuffer(event.dataTransfer.files[0]);
                });

                ["drag", "dragstart", "dragend", "dragover", "dragenter", "dragleave", "drop"].forEach(eventName => {
                    dropEl.addEventListener(eventName, event => {
                        event.preventDefault();
                        event.stopPropagation();
                    });
                });

                ["dragover", "dragenter"].forEach(eventName => {
                    dropEl.addEventListener(eventName, event => {
                        dropEl.classList.add("hover");
                    });
                });

                ["dragleave", "dragend", "drop"].forEach(eventName => {
                    dropEl.addEventListener(eventName, event => {
                        dropEl.classList.remove("hover");
                    });
                });
            };
        </script>
    </body>
</html>
