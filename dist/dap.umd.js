!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).DAPjs={})}(this,(function(e){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};function n(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function u(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){e.done?i(e.value):new n((function(t){t(e.value)})).then(s,u)}a((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}function o(){}function s(){s.init.call(this)}function u(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function a(e,t,n){if(t)e.call(n);else for(var r=e.length,i=v(e,r),o=0;o<r;++o)i[o].call(n)}function c(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,o=v(e,i),s=0;s<i;++s)o[s].call(n,r)}function f(e,t,n,r,i){if(t)e.call(n,r,i);else for(var o=e.length,s=v(e,o),u=0;u<o;++u)s[u].call(n,r,i)}function h(e,t,n,r,i,o){if(t)e.call(n,r,i,o);else for(var s=e.length,u=v(e,s),a=0;a<s;++a)u[a].call(n,r,i,o)}function p(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,o=v(e,i),s=0;s<i;++s)o[s].apply(n,r)}function d(e,t,n,r){var i,s,a,c;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),a=s[t]):(s=e._events=new o,e._eventsCount=0),a){if("function"==typeof a?a=s[t]=r?[n,a]:[a,n]:r?a.unshift(n):a.push(n),!a.warned&&(i=u(e))&&i>0&&a.length>i){a.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=e,f.type=t,f.count=a.length,c=f,"function"==typeof console.warn?console.warn(c):console.log(c)}}else a=s[t]=n,++e._eventsCount;return e}function l(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function m(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function v(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}o.prototype=Object.create(null),s.EventEmitter=s,s.usingDomains=!1,s.prototype.domain=void 0,s.prototype._events=void 0,s.prototype._maxListeners=void 0,s.defaultMaxListeners=10,s.init=function(){this.domain=null,s.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new o,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){var t,n,r,i,o,s,u,d="error"===e;if(s=this._events)d=d&&null==s.error;else if(!d)return!1;if(u=this.domain,d){if(t=arguments[1],!u){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=u,t.domainThrown=!1,u.emit("error",t),!1}if(!(n=s[e]))return!1;var m="function"==typeof n;switch(r=arguments.length){case 1:a(n,m,this);break;case 2:c(n,m,this,arguments[1]);break;case 3:f(n,m,this,arguments[1],arguments[2]);break;case 4:h(n,m,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),o=1;o<r;o++)i[o-1]=arguments[o];p(n,m,this,i)}return!0},s.prototype.addListener=function(e,t){return d(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return d(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,l(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,l(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,s,u;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new o:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){u=n[s].listener,i=s;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new o,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,u||t)}return this},s.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new o,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new o:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new o,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},s.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},s.prototype.listenerCount=m,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var y,w=1e7,g=4,C=2,b=5,A=function(e){function t(t,n,r){void 0===n&&(n=0),void 0===r&&(r=w);var i=e.call(this)||this;i.transport=t,i.mode=n,i.clockFrequency=r,i.connected=!1,i.blockSize=i.transport.packetSize-g-1;var o=i.transport.packetSize-C-1;return i.operationCount=Math.floor(o/b),i}return n(t,e),t.prototype.delay=function(e){return new Promise((function(t,n){setTimeout(t,e)}))},t.prototype.bufferSourceToUint8Array=function(e,t){if(!t)return new Uint8Array([e]);var n=void 0!==t.buffer?t.buffer:t,r=new Uint8Array(n.byteLength+1);return r.set([e]),r.set(new Uint8Array(n),1),r},t.prototype.selectProtocol=function(e){var t=this,n=2===e?59196:59294;return this.swjSequence(new Uint8Array([255,255,255,255,255,255,255])).then((function(){return t.swjSequence(new Uint16Array([n]))})).then((function(){return t.swjSequence(new Uint8Array([255,255,255,255,255,255,255]))})).then((function(){return t.swjSequence(new Uint8Array([0]))}))},t.prototype.send=function(e,t){var n=this,r=this.bufferSourceToUint8Array(e,t);return this.transport.write(r).then((function(){return n.transport.read()})).then((function(t){if(t.getUint8(0)!==e)throw new Error("Bad response for "+e+" -> "+t.getUint8(0));switch(e){case 3:case 8:case 9:case 10:case 17:case 18:case 19:case 29:case 23:case 24:case 26:case 21:case 22:case 4:if(0!==t.getUint8(1))throw new Error("Bad status for "+e+" -> "+t.getUint8(1))}return t}))},t.prototype.dapInfo=function(e){return this.send(0,new Uint8Array([e])).then((function(t){var n=t.getUint8(1);if(0===n)throw new Error("DAP Info Failure");switch(e){case 240:case 254:case 255:case 253:if(1===n)return t.getUint8(2);if(2===n)return t.getUint16(2);if(4===n)return t.getUint32(2)}var r=Array.prototype.slice.call(new Uint8Array(t.buffer,2,n));return String.fromCharCode.apply(null,r)}))},t.prototype.swjSequence=function(e){var t=8*e.byteLength,n=this.bufferSourceToUint8Array(t,e);return this.send(18,n).then((function(){}))},t.prototype.configureTransfer=function(e,t,n){var r=new Uint8Array(5),i=new DataView(r.buffer);return i.setUint8(0,e),i.setUint16(1,t,!0),i.setUint16(3,n,!0),this.send(4,r).then((function(){}))},t.prototype.connect=function(){var e=this;return!0===this.connected?Promise.resolve():this.transport.open().then((function(){return e.send(17,new Uint32Array([e.clockFrequency]))})).then((function(){return e.send(2,new Uint8Array([e.mode]))})).then((function(t){if(0===t.getUint8(1)||0!==e.mode&&t.getUint8(1)!==e.mode)throw new Error("Mode not enabled.")})).then((function(){return e.configureTransfer(0,100,0)})).then((function(){return e.selectProtocol(1)})).then((function(){e.connected=!0}))},t.prototype.disconnect=function(){var e=this;return!1===this.connected?Promise.resolve():this.send(3).then((function(){return e.transport.close()})).then((function(){e.connected=!1}))},t.prototype.reconnect=function(){var e=this;return this.disconnect().then((function(){return e.delay(100)})).then((function(){return e.connect()}))},t.prototype.reset=function(){return this.send(10).then((function(e){return 1===e.getUint8(2)}))},t.prototype.transfer=function(e,t,n,r){var i;void 0===t&&(t=2),void 0===n&&(n=0),void 0===r&&(r=0),i="number"==typeof e?[{port:e,mode:t,register:n,value:r}]:e;var o=new Uint8Array(C+i.length*b),s=new DataView(o.buffer);return s.setUint8(0,0),s.setUint8(1,i.length),i.forEach((function(e,t){var n=C+t*b;s.setUint8(n,e.port|e.mode|e.register),s.setUint32(n+1,e.value||0,!0)})),this.send(5,o).then((function(t){if(t.getUint8(1)!==i.length)throw new Error("Transfer count mismatch");var n=t.getUint8(2);if(2===n)throw new Error("Transfer response WAIT");if(4===n)throw new Error("Transfer response FAULT");if(8===n)throw new Error("Transfer response PROTOCOL_ERROR");if(16===n)throw new Error("Transfer response VALUE_MISMATCH");if(7===n)throw new Error("Transfer response NO_ACK");if("number"==typeof e)return t.getUint32(3,!0);var r=4*i.length;return new Uint32Array(t.buffer.slice(3,3+r))}))},t.prototype.transferBlock=function(e,t,n){var r,i,o=g;"number"==typeof n?(r=n,i=2):(r=n.length,i=0,o+=n.byteLength);var s=new Uint8Array(o),u=new DataView(s.buffer);return u.setUint8(0,0),u.setUint16(1,r,!0),u.setUint8(3,e|i|t),"number"!=typeof n&&s.set(n,g),this.send(6,u).then((function(e){if(e.getUint16(1,!0)!==r)throw new Error("Transfer count mismatch");var t=e.getUint8(3);if(2&t)throw new Error("Transfer response WAIT");if(4&t)throw new Error("Transfer response FAULT");if(8&t)throw new Error("Transfer response PROTOCOL_ERROR");if(7&t)throw new Error("Transfer response NO_ACK");if("number"==typeof n)return new Uint32Array(e.buffer.slice(4))}))},t}(s),P=/[\xc0-\xff][\x80-\xbf]*$/g,U=/[\xc0-\xff][\x80-\xbf]*/g,E=function(){function e(){}return e.prototype.decode=function(e){var t=Array.prototype.slice.call(new Uint8Array(e)),n=String.fromCodePoint.apply(void 0,t);this.partialChar&&(n=""+this.partialChar+n,this.partialChar=void 0);var r=n.match(P);if(r){var i=r[0].length;this.partialChar=n.slice(-i),n=n.slice(0,-i)}return n.replace(U,this.decoderReplacer)},e.prototype.decoderReplacer=function(e){var t=e.codePointAt(0)<<24,n=Math.clz32(~t),r=0,i=e.length,o="";if(n<5&&i>=n){for(t=t<<n>>>24+n,r=1;r<n;r+=1)t=t<<6|63&e.codePointAt(r);t<=65535?o+=String.fromCodePoint(t):t<=1114111?(t-=65536,o+=String.fromCodePoint(55296+(t>>10),56320+(1023&t))):r=0}for(;r<i;r+=1)o+="�";return o},e}(),L=new E,T=function(e){function t(n,o,s){void 0===o&&(o=0),void 0===s&&(s=w);var u=e.call(this,n,o,s)||this;return u.serialPolling=!1,u.serialListeners=!1,u.on("newListener",(function(e){return r(u,void 0,void 0,(function(){return i(this,(function(n){return e===t.EVENT_SERIAL_DATA&&0===this.listenerCount(e)&&(this.serialListeners=!0),[2]}))}))})),u.on("removeListener",(function(e){e===t.EVENT_SERIAL_DATA&&(0===u.listenerCount(e)&&(u.serialListeners=!1))})),u}return n(t,e),t.prototype.isBufferBinary=function(e){for(var t=Array.prototype.slice.call(new Uint16Array(e,0,50)),n=String.fromCharCode.apply(null,t),r=0;r<n.length;r++){var i=n.charCodeAt(r);if(65533===i||i<=8)return!0}return!1},t.prototype.writeBuffer=function(e,n,r){var i=this;void 0===r&&(r=0);var o=Math.min(e.byteLength,r+n),s=e.slice(r,o),u=new Uint8Array(s.byteLength+1);return u.set([s.byteLength]),u.set(new Uint8Array(s),1),this.send(140,u).then((function(){return i.emit(t.EVENT_PROGRESS,r/e.byteLength),o<e.byteLength?i.writeBuffer(e,n,o):Promise.resolve()}))},t.prototype.flash=function(e,n){var r=this;void 0===n&&(n=62);var i=void 0!==e.buffer?e.buffer:e,o=this.isBufferBinary(i)?0:1;return this.send(138,new Uint32Array([o])).then((function(e){return 0!==e.getUint8(1)?Promise.reject("Flash error"):r.writeBuffer(i,n)})).then((function(){return r.emit(t.EVENT_PROGRESS,1),r.send(139)})).then((function(e){return 0!==e.getUint8(1)?Promise.reject("Flash error"):r.send(137)})).then((function(){}))},t.prototype.getSerialBaudrate=function(){return this.send(129).then((function(e){return e.getUint32(1,!0)}))},t.prototype.setSerialBaudrate=function(e){return void 0===e&&(e=9600),this.send(130,new Uint32Array([e])).then((function(){}))},t.prototype.serialWrite=function(e){var t=e.split("").map((function(e){return e.charCodeAt(0)}));return t.unshift(t.length),this.send(132,new Uint8Array(t).buffer).then((function(){}))},t.prototype.serialRead=function(){return this.send(131).then((function(e){if(0!==e.byteLength&&131===e.getUint8(0)){var t=e.getUint8(1);if(0!==t){return e.buffer.slice(2,2+t)}}}))},t.prototype.startSerialRead=function(e,n){return void 0===e&&(e=100),void 0===n&&(n=!0),r(this,void 0,void 0,(function(){var r,o,s;return i(this,(function(i){switch(i.label){case 0:this.serialPolling=!0,i.label=1;case 1:return this.serialPolling?this.serialListeners?(r=this.connected,!1!==this.connected||!0!==n?[3,3]:[4,this.connect()]):[3,7]:[3,9];case 2:i.sent(),i.label=3;case 3:return[4,this.serialRead()];case 4:return o=i.sent(),!1!==r||!0!==n?[3,6]:[4,this.disconnect()];case 5:i.sent(),i.label=6;case 6:void 0!==o&&(s=L.decode(o),this.emit(t.EVENT_SERIAL_DATA,s)),i.label=7;case 7:return[4,new Promise((function(t){return setTimeout((function(){return t()}),e)}))];case 8:return i.sent(),[3,1];case 9:return[2]}}))}))},t.prototype.stopSerialRead=function(){this.serialPolling=!1},t.EVENT_PROGRESS="progress",t.EVENT_SERIAL_DATA="serial",t}(A),_=function(){function e(e,t,n){void 0===t&&(t=0),void 0===n&&(n=w),this.proxy=void 0!==e.open?new A(e,t,n):e}return e.prototype.delay=function(e){return new Promise((function(t,n){setTimeout(t,e)}))},e.prototype.waitDelay=function(e,t,n){var r=this;void 0===t&&(t=100),void 0===n&&(n=0);var i=!0,o=function(n){return i?n?Promise.resolve():r.delay(t).then(e).then(o):Promise.resolve()};return new Promise((function(e,t){return n>0&&setTimeout((function(){i=!1,t("Wait timed out")}),n),o(!1).then((function(){return e()}))}))},e.prototype.concatTypedArray=function(e){if(1===e.length)return e[0];for(var t=0,n=0,r=e;n<r.length;n++){t+=r[n].length}for(var i=new Uint32Array(t),o=0,s=0;o<e.length;o++)i.set(e[o],s),s+=e[o].length;return i},e.prototype.readDPCommand=function(e){return[{mode:2,port:0,register:e}]},e.prototype.writeDPCommand=function(e,t){if(8===e){if(t===this.selectedAddress)return[];this.selectedAddress=t}return[{mode:0,port:0,register:e,value:t}]},e.prototype.readAPCommand=function(e){var t=4278190080&e|240&e;return this.writeDPCommand(8,t).concat({mode:2,port:1,register:e})},e.prototype.writeAPCommand=function(e,t){if(0===e){if(t===this.cswValue)return[];this.cswValue=t}var n=4278190080&e|240&e;return this.writeDPCommand(8,n).concat({mode:0,port:1,register:e,value:t})},e.prototype.readMem16Command=function(e){return this.writeAPCommand(0,587202641).concat(this.writeAPCommand(4,e)).concat(this.readAPCommand(12))},e.prototype.writeMem16Command=function(e,t){return this.writeAPCommand(0,587202641).concat(this.writeAPCommand(4,e)).concat(this.writeAPCommand(12,t))},e.prototype.readMem32Command=function(e){return this.writeAPCommand(0,587202642).concat(this.writeAPCommand(4,e)).concat(this.readAPCommand(12))},e.prototype.writeMem32Command=function(e,t){return this.writeAPCommand(0,587202642).concat(this.writeAPCommand(4,e)).concat(this.writeAPCommand(12,t))},e.prototype.transferSequence=function(e){var t=this,n=[];n=n.concat.apply(n,e);for(var r=Promise.resolve([]),i=function(){var e=n.splice(0,o.proxy.operationCount);r=r.then((function(n){return t.proxy.transfer(e).then((function(e){return n.concat([e])}))}))},o=this;n.length;)i();return r.then((function(e){return t.concatTypedArray(e)}))},e.prototype.connect=function(){var e=this;return this.proxy.connect().then((function(){return e.readDP(0)})).then((function(){return e.transferSequence([e.writeDPCommand(0,4),e.writeDPCommand(8,0),e.writeDPCommand(4,1342177280)])})).then((function(){return e.waitDelay((function(){return e.readDP(4).then((function(e){return-1610612736==(-1610612736&e)}))}))}))},e.prototype.disconnect=function(){return this.proxy.disconnect()},e.prototype.reconnect=function(){var e=this;return this.disconnect().then((function(){return e.delay(100)})).then((function(){return e.connect()}))},e.prototype.reset=function(){return this.proxy.reset()},e.prototype.readDP=function(e){return this.proxy.transfer(this.readDPCommand(e)).then((function(e){return e[0]}))},e.prototype.writeDP=function(e,t){return this.proxy.transfer(this.writeDPCommand(e,t)).then((function(){}))},e.prototype.readAP=function(e){return this.proxy.transfer(this.readAPCommand(e)).then((function(e){return e[0]}))},e.prototype.writeAP=function(e,t){return this.proxy.transfer(this.writeAPCommand(e,t)).then((function(){}))},e.prototype.readMem16=function(e){return this.proxy.transfer(this.readMem16Command(e)).then((function(e){return e[0]}))},e.prototype.writeMem16=function(e,t){return t<<=(2&e)<<3,this.proxy.transfer(this.writeMem16Command(e,t)).then((function(){}))},e.prototype.readMem32=function(e){return this.proxy.transfer(this.readMem32Command(e)).then((function(e){return e[0]}))},e.prototype.writeMem32=function(e,t){return this.proxy.transfer(this.writeMem32Command(e,t)).then((function(){}))},e.prototype.readBlock=function(e,t){for(var n=this,r=this.transferSequence([this.writeAPCommand(0,587202642),this.writeAPCommand(4,e)]).then((function(){return[]})),i=t,o=function(){var e=Math.min(i,s.proxy.blockSize);r=r.then((function(t){return n.proxy.transferBlock(1,12,e).then((function(e){return t.concat([e])}))})),i-=e},s=this;i>0;)o();return r.then((function(e){return n.concatTypedArray(e)}))},e.prototype.writeBlock=function(e,t){for(var n=this,r=this.transferSequence([this.writeAPCommand(0,587202642),this.writeAPCommand(4,e)]).then((function(){})),i=0,o=function(){var e=t.slice(i,i+s.proxy.blockSize);r=r.then((function(){return n.proxy.transferBlock(1,12,e)})),i+=s.proxy.blockSize},s=this;i<t.length;)o();return r},e}(),S=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.enableDebug=function(){return this.writeMem32(3758157296,-1604386815)},t.prototype.readCoreRegisterCommand=function(e){return this.writeMem32Command(3758157300,e).concat(this.readMem32Command(3758157296)).concat(this.readMem32Command(3758157304))},t.prototype.writeCoreRegisterCommand=function(e,t){return this.writeMem32Command(3758157304,t).concat(this.writeMem32Command(3758157300,65536|e))},t.prototype.getState=function(){var e=this;return this.readMem32(3758157296).then((function(t){var n;return n=524288&t?1:262144&t?2:131072&t?3:4,33554432&t?e.readMem32(3758157296).then((function(e){return 33554432&e&&!(16777216&e)?0:n})):n}))},t.prototype.isHalted=function(){return this.readMem32(3758157296).then((function(e){return!!(131072&e)}))},t.prototype.halt=function(e,t){var n=this;return void 0===e&&(e=!0),void 0===t&&(t=0),this.isHalted().then((function(r){return r?Promise.resolve():n.writeMem32(3758157296,-1604386813).then((function(){return e?n.waitDelay((function(){return n.isHalted()}),100,t):Promise.resolve()}))}))},t.prototype.resume=function(e,t){var n=this;return void 0===e&&(e=!0),void 0===t&&(t=0),this.isHalted().then((function(r){return r?n.writeMem32(3758157104,7).then((function(){return n.enableDebug()})).then((function(){return e?n.waitDelay((function(){return n.isHalted().then((function(e){return!e}))}),100,t):Promise.resolve()})):Promise.resolve()}))},t.prototype.readCoreRegister=function(e){var t=this;return this.transferSequence([this.writeMem32Command(3758157300,e),this.readMem32Command(3758157296)]).then((function(e){if(!(65536&e[0]))throw new Error("Register not ready");return t.readMem32(3758157304)}))},t.prototype.readCoreRegisters=function(e){var t=this,n=Promise.resolve([]);return e.forEach((function(e){n=n.then((function(n){return t.readCoreRegister(e).then((function(e){return n.concat([e])}))}))})),n},t.prototype.writeCoreRegister=function(e,t){return this.transferSequence([this.writeMem32Command(3758157304,t),this.writeMem32Command(3758157300,65536|e),this.readMem32Command(3758157296)]).then((function(e){if(!(65536&e[0]))throw new Error("Register not ready")}))},t.prototype.execute=function(e,t,n,r,i){var o=this;void 0===i&&(i=e+1);for(var s=[],u=5;u<arguments.length;u++)s[u-5]=arguments[u];if(48682!==t[t.length-1]){var a=new Uint32Array(t.length+1);a.set(t),a.set([48682],t.length-1),t=a}for(var c=[this.writeCoreRegisterCommand(13,n),this.writeCoreRegisterCommand(15,r),this.writeCoreRegisterCommand(14,i)],f=0;f<Math.min(s.length,12);f++)c.push(this.writeCoreRegisterCommand(f,s[f]));return this.halt().then((function(){return o.transferSequence(c)})).then((function(){return o.writeBlock(e,t)})).then((function(){return o.resume(!1)})).then((function(){return o.waitDelay((function(){return o.isHalted()}),100,1e4)}))},t}(_);(y=e.FPBCtrlMask||(e.FPBCtrlMask={}))[y.ENABLE=1]="ENABLE",y[y.KEY=2]="KEY";var x=function(){function e(e){this.os="browser",this.packetSize=64,this.path=void 0!==e.path?e.path:e}return e.prototype.open=function(){var e=this;return new Promise((function(t,n){if(!e.path.length)return n("No path specified");try{var r=require("node-hid");e.device=new r.HID(e.path),t()}catch(e){n(e)}}))},e.prototype.close=function(){var e=this;return new Promise((function(t,n){e.device&&e.device.close(),t()}))},e.prototype.read=function(){var e=this;return new Promise((function(t,n){if(!e.device)return n("No device opened");e.device.read((function(e,r){if(e)return n(e);var i=new Uint8Array(r).buffer;t(new DataView(i))}))}))},e.prototype.write=function(e){var t=this;return new Promise((function(n,r){if(!t.device)return r("No device opened");for(var i=void 0!==e.buffer?e.buffer:e,o=Array.prototype.slice.call(new Uint8Array(i));o.length<t.packetSize;)o.push(0);if("win32"===t.os&&o.unshift(0),t.device.write(o)!==o.length)return r("Incorrect bytecount written");n()}))},e}(),M=1,D=255,N=function(){function e(e,t,n,r){void 0===t&&(t=D),void 0===n&&(n=M),void 0===r&&(r=!1),this.device=e,this.interfaceClass=t,this.configuration=n,this.alwaysControlTransfer=r,this.packetSize=64}return e.prototype.bufferToDataView=function(e){var t=new Uint8Array(e).buffer;return new DataView(t)},e.prototype.bufferSourceToBuffer=function(e){var t=void 0!==e.buffer?e.buffer:e;return Buffer.from(t)},e.prototype.extendBuffer=function(e,t){var n=void 0!==e.buffer?e.buffer:e,r=Math.min(n.byteLength,t),i=new Uint8Array(r);return i.set(new Uint8Array(n)),i},e.prototype.open=function(){var e=this;return new Promise((function(t,n){e.device.open(),e.device.setConfiguration(e.configuration,(function(r){if(r)return n(r);var i=e.device.interfaces.filter((function(t){return t.descriptor.bInterfaceClass===e.interfaceClass}));if(!i.length)throw new Error("No valid interfaces found.");var o=i.find((function(e){return e.endpoints.length>0}));if(o||(o=i[0]),e.interfaceNumber=o.interfaceNumber,!e.alwaysControlTransfer){var s=o.endpoints;e.endpointIn=void 0,e.endpointOut=void 0;for(var u=0,a=s;u<a.length;u++){var c=a[u];"in"===c.direction?e.endpointIn=c:e.endpointOut=c}if(e.endpointIn||e.endpointOut)try{o.claim()}catch(t){e.endpointIn=void 0,e.endpointOut=void 0}}t()}))}))},e.prototype.close=function(){var e=this;return new Promise((function(t,n){e.device.close(),t()}))},e.prototype.read=function(){var e=this;return new Promise((function(t,n){if(void 0===e.interfaceNumber)return n("No device opened");e.endpointIn?e.endpointIn.transfer(e.packetSize,(function(r,i){if(r)return n(r);t(e.bufferToDataView(i))})):e.device.controlTransfer(161,1,256,e.interfaceNumber,e.packetSize,(function(r,i){return r?n(r):i?void t(e.bufferToDataView(i)):n("No buffer read")}))}))},e.prototype.write=function(e){var t=this,n=this.extendBuffer(e,this.packetSize),r=this.bufferSourceToBuffer(n);return new Promise((function(e,n){if(void 0===t.interfaceNumber)return n("No device opened");t.endpointOut?t.endpointOut.transfer(r,(function(t){if(t)return n(t);e()})):t.device.controlTransfer(33,9,512,t.interfaceNumber,r,(function(t){if(t)return n(t);e()}))}))},e}(),k=1,R=255,O=function(){function e(e,t,n,r){void 0===t&&(t=R),void 0===n&&(n=k),void 0===r&&(r=!1),this.device=e,this.interfaceClass=t,this.configuration=n,this.alwaysControlTransfer=r,this.packetSize=64}return e.prototype.extendBuffer=function(e,t){var n=void 0!==e.buffer?e.buffer:e,r=Math.min(n.byteLength,t),i=new Uint8Array(r);return i.set(new Uint8Array(n)),i},e.prototype.open=function(){var e=this;return this.device.open().then((function(){return e.device.selectConfiguration(e.configuration)})).then((function(){var t=e.device.configuration.interfaces.filter((function(t){return t.alternates[0].interfaceClass===e.interfaceClass}));if(!t.length)throw new Error("No valid interfaces found.");var n=t.find((function(e){return e.alternates[0].endpoints.length>0}));if(n||(n=t[0]),e.interfaceNumber=n.interfaceNumber,!e.alwaysControlTransfer){var r=n.alternates[0].endpoints;e.endpointIn=void 0,e.endpointOut=void 0;for(var i=0,o=r;i<o.length;i++){var s=o[i];"in"===s.direction?e.endpointIn=s:e.endpointOut=s}}return e.device.claimInterface(e.interfaceNumber)}))},e.prototype.close=function(){return this.device.close()},e.prototype.read=function(){return void 0===this.interfaceNumber?Promise.reject("No device opened"):this.endpointIn?this.device.transferIn(this.endpointIn.endpointNumber,this.packetSize).then((function(e){return e.data})):this.device.controlTransferIn({requestType:"class",recipient:"interface",request:1,value:256,index:this.interfaceNumber},this.packetSize).then((function(e){return e.data}))},e.prototype.write=function(e){if(void 0===this.interfaceNumber)return Promise.reject("No device opened");var t=this.extendBuffer(e,this.packetSize);return this.endpointOut?this.device.transferOut(this.endpointOut.endpointNumber,t).then((function(){})):this.device.controlTransferOut({requestType:"class",recipient:"interface",request:9,value:512,index:this.interfaceNumber},t).then((function(){}))},e}();e.ADI=_,e.CmsisDAP=A,e.CortexM=S,e.DAPLink=T,e.DEFAULT_CLOCK_FREQUENCY=w,e.HID=x,e.USB=N,e.WebUSB=O,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=dap.umd.js.map
